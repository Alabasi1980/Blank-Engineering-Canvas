
# دستور المحرك العام (Generic Engine Constitution)

هذه الوثيقة تمثل **المرجع النهائي** للمعايير الهندسية التي تحكم تحويل التطبيق من "نظام متخصص" إلى "محرك مجرد" (Abstract Engine). أي كود أو منطق يخالف هذه القواعد يعتبر **Bug** يجب إصلاحه.

---

## 1. المبدأ الجوهري: العمى الوظيفي (The Blind Core)
**القاعدة:** المحرك (Runtime) يجب ألا "يعرف" أو "يفهم" طبيعة العمل التجاري للمستخدم.

*   **ممنوع (Forbidden):** استخدام مصطلحات مثل `Warehouse`, `Account`, `Material`, `Invoice` داخل ملفات المنطق الأساسية (`core/logic`).
*   **مسموح (Allowed):** استخدام مصطلحات مجردة مثل `Entity`, `Dimension`, `Node`, `Transaction`, `Document`.
*   **التطبيق:** بدلاً من `if (dimension === 'warehouse')`، يجب أن يكون المنطق `if (config.dimensions[id].type === 'hierarchy')`.

---

## 2. حالة الصفر (Zero-State Axiom)
**القاعدة:** عند تثبيت التطبيق لأول مرة، يجب أن يكون فارغاً تماماً من أي افتراضات مسبقة.

*   **الحالة الأولية:**
    *   قائمة الأبعاد (Dimensions Registry): **فارغة**.
    *   القوائم المرجعية (Master Data): **فارغة**.
    *   قواعد المحرك (Rules): **فارغة**.
*   **الاستثناء الوحيد:** يُسمح بوجود "قوالب اختيارية" (Optional Templates) يختار المستخدم تحميلها بنفسه (مثلاً: "قالب شركة مقاولات")، ولكن لا يجوز تحميلها قسراً في الكود.

---

## 3. حياد نموذج البيانات (Data Model Agnosticism)
**القاعدة:** البيانات المدخلة لا تملك "شكلاً ثابتاً" مفروضاً من النظام.

*   **النموذج القديم (Legacy Transaction):**
    ```typescript
    interface Transaction { warehouseId: string; accountId: string; ... } // مرفوض
    ```
*   **النموذج الجديد (Generic Row):**
    ```typescript
    interface GenericTransaction {
      timestamp: string;
      value: number; // القيمة المعيارية (Amount)
      attributes: Record<string, any>; // أي بيانات أخرى (مستودع، حساب، سائق...)
    }
    ```
*   **التطبيق:** أي حقل غير `Date` و `Amount` يجب أن يُعامل كـ `Attribute` ديناميكي يتم تعريفه في الـ Config.

---

## 4. سياسة التوافق (Legacy via Migration)
**القاعدة:** دعم النسخ القديمة لا يعني تلويث المحرك الجديد.

*   **ممنوع:** وضع جمل `if (isLegacy)` داخل حلقات المعالجة (Loops) أو الـ Components.
*   **الإجراء الصحيح:** يتم تحويل البيانات القديمة (Migration) **مرة واحدة** عند التحميل (Load Time) لتتوافق مع الهيكلية العامة الجديدة. المحرك يتعامل فقط مع الهيكلية الجديدة.

---

## 5. الذكاء يأتي من التكوين (Intelligence via Config)
**القاعدة:** أي منطق ذكي (مثل: الفواتير تخصم، المرتجعات تضيف) يجب ألا يكون "مكتبوباً في الكود" (Hardcoded).

*   **الخطأ:** دالة `calculateTotal` تحتوي على `if (category === 'return') val * -1`.
*   **الصحيح:** دالة `calculateTotal` تقرأ `config.directionLogic[categoryId].multiplier`.
*   **النتيجة:** المستخدم هو من يقرر ما هو "سالب" وما هو "موجب"، وليس المبرمج.

---

## 6. حيادية الواجهة (UI Neutrality)
**القاعدة:** واجهة المستخدم لا تفترض وجود أيقونات أو مسميات محددة.

*   **الأيقونات:** لا تضع أيقونة "شاحنة" لبعد يسمى `Assets` بشكل ثابت. الأيقونة يجب أن تكون خاصية مخزنة في تعريف البعد (`dimension.icon`).
*   **المسميات:** لا تستخدم كلمة "المخازن" في القوائم. استخدم `{{dimension.label}}` (التي قد يسميها المستخدم "الفروع" أو "المطابخ" أو "المحافظ").

---

## قائمة التحقق للقبول (Acceptance Checklist)
قبل دمج أي ميزة، اسأل:
1.  هل تعمل هذه الميزة لشركة "تأجير سيارات" بنفس كفاءة عملها لشركة "مقاولات"؟
2.  هل اضطررت لكتابة اسم بُعد معين (String Literal) داخل الكود؟
3.  إذا حذف المستخدم كل إعداداته، هل ينهار التطبيق أم يعود لصفحة بيضاء نظيفة؟

